<template>
    <div class="bci-container">
        <!-- Initial Loading State -->
        <template if:true={initialLoading}>
            <div class="bci-loading-overlay">
                <lightning-spinner alternative-text="Loading" size="large" class="bci-loading-spinner"></lightning-spinner>
                <span class="bci-loading-text">Loading BCI Projects...</span>
            </div>
        </template>

        <template if:false={initialLoading}>
            <!-- Stats Bar with Controls -->
            <div class="bci-stats-bar">
                <div class="bci-stats-left">
                    <div class="bci-stat-item">
                        <div class="bci-stat-icon projects">
                            <lightning-icon icon-name="utility:database" size="x-small" alternative-text="Projects"></lightning-icon>
                        </div>
                        <div class="bci-stat-content">
                            <span class="bci-stat-value">{formattedTotal}</span>
                            <span class="bci-stat-label">Projects</span>
                        </div>
                    </div>

                    <div class="bci-stat-item">
                        <div class="bci-stat-icon value">
                            <lightning-icon icon-name="utility:moneybag" size="x-small" alternative-text="Value"></lightning-icon>
                        </div>
                        <div class="bci-stat-content">
                            <span class="bci-stat-value">{formattedTotalValue}</span>
                            <span class="bci-stat-label">Total Value</span>
                        </div>
                    </div>

                    <div class="bci-stat-item">
                        <div class="bci-stat-icon updated">
                            <lightning-icon icon-name="utility:clock" size="x-small" alternative-text="Updated"></lightning-icon>
                        </div>
                        <div class="bci-stat-content">
                            <span class="bci-stat-value">{filterValues.LastUpdated}</span>
                            <span class="bci-stat-label">Time Range</span>
                        </div>
                    </div>
                </div>

                <div class="bci-stats-right">
                    <!-- View Toggle -->
                    <div class="bci-view-toggle">
                        <template for:each={groupOptions} for:item="option">
                            <button
                                key={option.value}
                                class={option.buttonClass}
                                data-value={option.value}
                                onclick={handleViewToggleClick}>
                                {option.label}
                            </button>
                        </template>
                    </div>

                    <div class="bci-stats-divider"></div>

                    <!-- Map Button -->
                    <button class="bci-action-btn" onclick={navigateToBciMap}>
                        <lightning-icon icon-name="utility:location" size="x-small" alternative-text="Map"></lightning-icon>
                        <span>Map View</span>
                    </button>

                    <!-- Settings Menu -->
                    <div class="bci-settings-menu">
                        <lightning-button-menu
                            icon-name="utility:settings"
                            alternative-text="Settings"
                            menu-alignment="right"
                            variant="border"
                            onselect={handleMenuSelect}>
                            <lightning-menu-item value="resetWidths" label="Reset Column Widths"></lightning-menu-item>
                        </lightning-button-menu>
                    </div>

                    <!-- Refresh Button -->
                    <button class="bci-icon-btn" onclick={handleRefresh} title="Refresh">
                        <lightning-icon icon-name="utility:refresh" size="x-small" alternative-text="Refresh"></lightning-icon>
                    </button>
                </div>
            </div>

            <!-- Active Filter Pills -->
            <template if:true={hasActiveFilters}>
                <div class="bci-active-filters">
                    <span class="bci-filters-label">Active Filters:</span>

                    <template for:each={activeFilterPills} for:item="pill">
                        <span class="bci-filter-pill" key={pill.key}>
                            {pill.label}
                            <button class="bci-filter-pill-remove" data-filter={pill.filterType} data-value={pill.value} onclick={handleRemoveFilterPill} title="Remove filter">
                                <lightning-icon icon-name="utility:close" size="xx-small" alternative-text="Remove"></lightning-icon>
                            </button>
                        </span>
                    </template>

                    <button class="bci-clear-all-btn" onclick={handleCancelFilter}>Clear All</button>
                </div>
            </template>

            <!-- Main Content Area -->
            <div class="bci-main-content">
                <!-- Filter Panel -->
                <template if:true={showFilterPanel}>
                    <aside class="bci-filter-panel">
                        <div class="bci-filter-body">
                            <!-- Time Range Section -->
                            <div class={timeRangeSectionClass} data-section="timeRange">
                                <div class="bci-filter-section-header" onclick={toggleFilterSection} data-section="timeRange">
                                    <span class="bci-filter-section-title">
                                        <lightning-icon icon-name="utility:clock" size="xx-small" alternative-text="Time"></lightning-icon>
                                        Time Range
                                    </span>
                                    <lightning-icon icon-name="utility:chevrondown" size="xx-small" class="bci-filter-section-chevron" alternative-text="Toggle"></lightning-icon>
                                </div>
                                <div class="bci-filter-section-content">
                                    <div class="bci-time-pills">
                                        <template for:each={lastUpdatedOptions} for:item="option">
                                            <button
                                                key={option.value}
                                                class={option.pillClass}
                                                data-value={option.value}
                                                onclick={handleTimeRangeClick}>
                                                {option.shortLabel}
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Location Section -->
                            <div class={locationSectionClass} data-section="location">
                                <div class="bci-filter-section-header" onclick={toggleFilterSection} data-section="location">
                                    <span class="bci-filter-section-title">
                                        <lightning-icon icon-name="utility:location" size="xx-small" alternative-text="Location"></lightning-icon>
                                        Location
                                        <template if:true={locationFilterCount}>
                                            <span class="bci-filter-section-badge">{locationFilterCount}</span>
                                        </template>
                                    </span>
                                    <lightning-icon icon-name="utility:chevrondown" size="xx-small" class="bci-filter-section-chevron" alternative-text="Toggle"></lightning-icon>
                                </div>
                                <div class="bci-filter-section-content">
                                    <lightning-combobox
                                        data-field="State"
                                        label="State"
                                        placeholder="Select a state..."
                                        value={filterValues.State}
                                        options={stateOptions}
                                        onchange={handleFilterChange}>
                                    </lightning-combobox>

                                    <div class="slds-m-top_small">
                                        <label class="slds-form-element__label">Country</label>
                                        <div class="bci-checkbox-group slds-m-top_xx-small">
                                            <template for:each={countryOptions} for:item="country">
                                                <lightning-input
                                                    key={country.value}
                                                    type="checkbox"
                                                    label={country.label}
                                                    value={country.value}
                                                    checked={country.isChecked}
                                                    onchange={handleCountryCheckboxChange}
                                                    data-field="country">
                                                </lightning-input>
                                            </template>
                                        </div>
                                    </div>

                                    <div class="slds-m-top_small">
                                        <label class="slds-form-element__label">Council</label>
                                        <div class="bci-checkbox-group slds-m-top_xx-small">
                                            <template for:each={visiblecouncilOptions} for:item="option">
                                                <lightning-input
                                                    key={option.value}
                                                    type="checkbox"
                                                    label={option.label}
                                                    value={option.value}
                                                    checked={option.isChecked}
                                                    onchange={handleCouncilCheckboxChange}
                                                    data-field="Council">
                                                </lightning-input>
                                            </template>
                                        </div>
                                        <button class="bci-show-more-btn" onclick={toggleCouncilShowMoreModal}>
                                            Show all councils
                                            <lightning-icon icon-name="utility:chevronright" size="xx-small" alternative-text="More"></lightning-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Project Details Section -->
                            <div class={detailsSectionClass} data-section="details">
                                <div class="bci-filter-section-header" onclick={toggleFilterSection} data-section="details">
                                    <span class="bci-filter-section-title">
                                        <lightning-icon icon-name="utility:description" size="xx-small" alternative-text="Details"></lightning-icon>
                                        Project Details
                                        <template if:true={detailsFilterCount}>
                                            <span class="bci-filter-section-badge">{detailsFilterCount}</span>
                                        </template>
                                    </span>
                                    <lightning-icon icon-name="utility:chevrondown" size="xx-small" class="bci-filter-section-chevron" alternative-text="Toggle"></lightning-icon>
                                </div>
                                <div class="bci-filter-section-content">
                                    <lightning-input
                                        label="Developer"
                                        placeholder="Search developer..."
                                        data-field="Developer"
                                        value={filterValues.Developer}
                                        onkeydown={handleEnterKeyPress}
                                        onchange={handleFilterChange}>
                                    </lightning-input>

                                    <div class="slds-m-top_small">
                                        <label class="slds-form-element__label">Category</label>
                                        <div class="bci-checkbox-group slds-m-top_xx-small">
                                            <template for:each={visiblecategoryOptions} for:item="option">
                                                <lightning-input
                                                    key={option.value}
                                                    type="checkbox"
                                                    label={option.label}
                                                    value={option.value}
                                                    checked={option.isChecked}
                                                    onchange={handleCategoryCheckboxChange}
                                                    data-field="Cat_1_Name">
                                                </lightning-input>
                                            </template>
                                        </div>
                                        <button class="bci-show-more-btn" onclick={toggleCategoryShowMoreModal}>
                                            Show all categories
                                            <lightning-icon icon-name="utility:chevronright" size="xx-small" alternative-text="More"></lightning-icon>
                                        </button>
                                    </div>

                                    <div class="slds-m-top_small">
                                        <label class="slds-form-element__label">Project Stage</label>
                                        <div class="bci-checkbox-group slds-m-top_xx-small">
                                            <template for:each={projectStageOptions} for:item="option">
                                                <lightning-input
                                                    key={option.value}
                                                    type="checkbox"
                                                    label={option.label}
                                                    value={option.value}
                                                    checked={option.isChecked}
                                                    onchange={handleProjectStageCheckboxChange}
                                                    data-field="Project_Stage">
                                                </lightning-input>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- View Options Section -->
                            <div class={viewOptionsSectionClass} data-section="viewOptions">
                                <div class="bci-filter-section-header" onclick={toggleFilterSection} data-section="viewOptions">
                                    <span class="bci-filter-section-title">
                                        <lightning-icon icon-name="utility:preview" size="xx-small" alternative-text="View"></lightning-icon>
                                        View Options
                                    </span>
                                    <lightning-icon icon-name="utility:chevrondown" size="xx-small" class="bci-filter-section-chevron" alternative-text="Toggle"></lightning-icon>
                                </div>
                                <div class="bci-filter-section-content">
                                    <div class="bci-toggle-switch" onclick={handleHideViewedToggle}>
                                        <lightning-input
                                            type="checkbox"
                                            checked={filterValues.HideViewedProjects}
                                            onchange={handleHideViewedCheckboxChange}
                                            variant="label-hidden"
                                            label="Hide Viewed">
                                        </lightning-input>
                                        <span class="bci-toggle-label">
                                            <lightning-icon icon-name="utility:hide" size="xx-small" alternative-text="Hide"></lightning-icon>
                                            Hide Viewed Projects
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Actions -->
                        <div class="bci-filter-actions">
                            <button class="bci-btn bci-btn-secondary" onclick={handleCancelFilter}>
                                Clear
                            </button>
                            <button class="bci-btn bci-btn-primary" onclick={handleApplyFilter}>
                                Apply Filters
                            </button>
                        </div>
                    </aside>
                </template>

                <!-- Data Table Container -->
                <div class="bci-table-container">
                    <div class="bci-table-wrapper">
                        <!-- Loading Overlay -->
                        <template if:true={isLoading}>
                            <div class="bci-loading-overlay bci-fade-in">
                                <lightning-spinner alternative-text="Loading" size="medium" class="bci-loading-spinner"></lightning-spinner>
                                <span class="bci-loading-text">Fetching projects...</span>
                            </div>
                        </template>

                        <!-- Data Table -->
                        <template if:true={hasData}>
                            <c-my-custom-type-datatable
                                key-field="Id"
                                data={bciProjects}
                                hide-checkbox-column
                                columns={columns}
                                enable-infinite-loading
                                onloadmore={loadMoreData}
                                sorted-by={sortBy}
                                sorted-direction={sortDirection}
                                onclick={handleClick}
                                onsort={doSorting}>
                            </c-my-custom-type-datatable>
                        </template>

                        <!-- Empty State -->
                        <template if:false={hasData}>
                            <template if:false={isLoading}>
                                <div class="bci-empty-state bci-fade-in">
                                    <div class="bci-empty-icon">
                                        <lightning-icon icon-name="utility:search" size="large" alternative-text="No results"></lightning-icon>
                                    </div>
                                    <h3 class="bci-empty-title">No Projects Found</h3>
                                    <p class="bci-empty-description">Try adjusting your filters or search criteria to find what you're looking for.</p>
                                    <button class="bci-btn bci-btn-primary" onclick={handleCancelFilter}>
                                        Clear All Filters
                                    </button>
                                </div>
                            </template>
                        </template>
                    </div>
                </div>
            </div>
        </template>

        <!-- Category Modal -->
        <template if:true={showCategoryModal}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-modal="true">
                <div class="slds-modal__container bci-modal-container">
                    <header class="bci-modal-header">
                        <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={toggleCategoryShowMoreModal}>
                            <lightning-icon icon-name="utility:close" alternative-text="Close" size="small"></lightning-icon>
                            <span class="slds-assistive-text">Close</span>
                        </button>
                        <h2 class="bci-modal-title">Select Project Categories</h2>
                    </header>

                    <div class="bci-modal-body bci-modal-body-listbox">
                        <lightning-dual-listbox
                            name="projectType"
                            label="Categories"
                            source-label="Available"
                            selected-label="Selected"
                            data-field="Cat_1_Name"
                            field-level-help="Select categories to filter projects"
                            options={categoryOptions}
                            value={filterValues.Cat_1_Name}
                            onchange={handleFilterChange}
                            size="8">
                        </lightning-dual-listbox>
                    </div>

                    <footer class="bci-modal-footer">
                        <button class="bci-btn bci-btn-secondary" onclick={toggleCategoryShowMoreModal}>Cancel</button>
                        <button class="bci-btn bci-btn-primary" onclick={toggleCategoryShowMoreModal}>Done</button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- Council Modal -->
        <template if:true={showCouncilModal}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium" aria-modal="true">
                <div class="slds-modal__container bci-modal-container">
                    <header class="bci-modal-header">
                        <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={toggleCouncilShowMoreModal}>
                            <lightning-icon icon-name="utility:close" alternative-text="Close" size="small"></lightning-icon>
                            <span class="slds-assistive-text">Close</span>
                        </button>
                        <h2 class="bci-modal-title">Select Councils</h2>
                    </header>

                    <div class="bci-modal-body bci-modal-body-listbox">
                        <lightning-dual-listbox
                            name="Council"
                            label="Councils"
                            source-label="Available"
                            selected-label="Selected"
                            data-field="Council"
                            field-level-help="Select councils to filter projects"
                            options={councilOptions}
                            value={filterValues.Council}
                            onchange={handleFilterChange}
                            size="8">
                        </lightning-dual-listbox>
                    </div>

                    <footer class="bci-modal-footer">
                        <button class="bci-btn bci-btn-secondary" onclick={toggleCouncilShowMoreModal}>Cancel</button>
                        <button class="bci-btn bci-btn-primary" onclick={toggleCouncilShowMoreModal}>Done</button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- BCI Map Modal -->
        <template if:true={isBciMapModalOpen}>
            <section class="slds-modal slds-fade-in-open" aria-modal="true">
                <div class="slds-modal__container" style="max-width: 95%; width: 95%;">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={navigateToBciMap}>
                        <lightning-icon icon-name="utility:close" alternative-text="Close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <div class="slds-modal__content" style="height: 90vh; border-radius: 8px; overflow: hidden;">
                        <iframe src="https://projects-map.stamfordcapital.app/" width="100%" height="100%" frameborder="0"></iframe>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </div>
</template>
